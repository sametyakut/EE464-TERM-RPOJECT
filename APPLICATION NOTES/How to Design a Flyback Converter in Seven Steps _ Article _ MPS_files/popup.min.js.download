define(['jquery','Magento_Customer/js/customer-data','mageplaza/core/jquery/popup'],function($,customerData){$.widget('mageplaza.socialpopup',{options:{popup:'#social-login-popup',popupEffect:'',headerLink:'.header .links, .section-item-content .header.links',fromproductpageLink:'.download-sheet .mpsplusloginpopup',fromaddtocartLink:'.product-add-form .box-tocart',ajaxLoading:'#social-login-popup .ajax-loading',loadingClass:'social-login-ajax-loading',errorMsgClass:'message-error error message',mpsuserType:'.user_action_is',loginBtntoAccessDocument:'#bnt-document-login-authentication',upgradenotificaionContainer:'.upgrade-account-msg-popup',DocumentLoginForm:'#document-form-login',successMsgClass:'message-success success message',custom_success:'#custom_success',DocumentloginFormContainer:'.social-login.mympsplus-login',DocuementloginFormContent:'.social-login.mympsplus-login .block-content',DocumentloginFormforgetBtn:'#document-form-login .action.remind',DocumentloginFormloginBtn:'#mymps-login-for-document',DocumentloginFormEmailID:'#document-form-login .control #email',pdfDocumentUrl:'',loginFormContainer:'.social-login.authentication',loginFormContent:'.social-login.authentication .social-login-customer-authentication .block-content',loginForm:'#social-form-login',loginBtn:'#bnt-social-login-authentication',forgotBtn:'#social-form-login .action.remind',createBtn:'#social-form-login .action.create',formLoginUrl:'',forgotFormContainer:'.social-login.forgot',forgotFormContent:'.social-login.forgot .block-content',forgotForm:'#social-form-password-forget',forgotSendBtn:'#social-form-password-forget .action.send',forgotBackBtn:'#social-form-password-forget .action.back',forgotFormUrl:'',forgotBackBtnMps:'#social-form-password-forget .action.back.mpsplus',loginFormEmailID:'#social-form-login .control #login_email',forgotFormemail:'#social-form-password-forget .control #email_address',forgotFormTitle:'.social-login.forgot .forgot-pass-title',forgotFormeDefaultmessage:'#social-form-password-forget .note',createFormContainer:'.social-login.create',createFormContent:'.social-login.create .block-content',createForm:'#social-form-create',createAccBtn:'#social-form-create .action.create',createBackBtn:'#social-form-create .action.back',createFormUrl:'',loginCaptchaImg:'.authentication .captcha-img',createCaptchaImg:'.create .captcha-img',forgotCaptchaImg:'.forgot .captcha-img'},_create:function(){this.initObject();this.initLink();this.initObserve();},initObject:function(){this.loginForm=$(this.options.loginForm);this.createForm=$(this.options.createForm);this.forgotForm=$(this.options.forgotForm);this.forgotFormContainer=$(this.options.forgotFormContainer);this.createFormContainer=$(this.options.createFormContainer);this.loginFormContainer=$(this.options.loginFormContainer);this.DocumentloginFormContainer=$(this.options.DocumentloginFormContainer);this.DocumentloginFormloginBtn=$(this.options.DocumentloginFormloginBtn);this.loginFormEmailID=$(this.options.loginFormEmailID);this.forgotFormemail=$(this.options.forgotFormemail);this.forgotFormTitle=$(this.options.forgotFormTitle);this.forgotFormeDefaultmessage=$(this.options.forgotFormeDefaultmessage);this.DocumentLoginForm=$(this.options.DocumentLoginForm);this.loginBtn=$(this.options.loginBtn);this.loginBtntoAccessDocument=$(this.options.loginBtntoAccessDocument);this.upgradenotificaionContainer=$(this.options.upgradenotificaionContainer);this.DocumentloginFormEmailID=$(this.options.DocumentloginFormEmailID);this.DocuementloginFormContent=$(this.options.DocuementloginFormContent);this.loginFormContent=$(this.options.loginFormContent);this.forgotFormContent=$(this.options.forgotFormContent);this.createFormContent=$(this.options.createFormContent);this.loginCaptchaImg=$(this.options.loginCaptchaImg);this.createCaptchaImg=$(this.options.createCaptchaImg);this.forgotCaptchaImg=$(this.options.forgotCaptchaImg);},initLink:function(){var self=this,headerLink=$(this.options.headerLink);productPageLink=$(this.options.fromproductpageLink);parametric_mpsplus_login_required=$('.parametric-mpsplus-login-required');if(productPageLink.length){productPageLink.find('a.login-required').each(function(link){var el=$(this),href=el.attr('href');el.addClass('social-login');el.attr('href',self.options.popup);el.attr('data-effect',self.options.popupEffect);el.on('click',function(event){self.mpsplusDocumentLogin();event.preventDefault();});});pdfDocumentUrl=productPageLink.find('#act_doc_url').val();productPageLink.magnificPopup({delegate:'a.social-login',removalDelay:500,callbacks:{beforeOpen:function(){this.st.mainClass=this.st.el.attr('data-effect');}},midClick:true});}
if(parametric_mpsplus_login_required.length){parametric_mpsplus_login_required.find('a.login-required').each(function(link){var el=$(this),href=el.attr('href');el.addClass('social-login');el.attr('href',self.options.popup);el.attr('data-effect',self.options.popupEffect);el.on('click',function(event){self.mpsplusDocumentLogin();event.preventDefault();});});pdfDocumentUrl='';parametric_mpsplus_login_required.magnificPopup({delegate:'a.social-login',removalDelay:500,callbacks:{beforeOpen:function(){this.st.mainClass=this.st.el.attr('data-effect');}},midClick:true});}
fromaddtocartLink=$(this.options.fromaddtocartLink);if(fromaddtocartLink.length){fromaddtocartLink.find('a.login-required').each(function(link){var el=$(this),href=el.attr('href');el.addClass('social-login');el.attr('href',self.options.popup);el.attr('data-effect',self.options.popupEffect);el.on('click',function(event){self.mpsplusDocumentLogin();event.preventDefault();});});pdfDocumentUrl='';fromaddtocartLink.magnificPopup({delegate:'a.social-login',removalDelay:500,callbacks:{beforeOpen:function(){this.st.mainClass=this.st.el.attr('data-effect');}},midClick:true});}
if(headerLink.length){headerLink.find('a').each(function(link){var el=$(this),href=el.attr('href');id=el.attr('id');if(typeof href!=='undefined'&&(id=='mps_login'||id=='mps_register'||href.search('mps/document/test')!=-1)){el.addClass('social-login');el.attr('href',self.options.popup);el.attr('data-effect',self.options.popupEffect);el.on('click',function(event){if(href.search('mps/document/test')!=-1){}
if(typeof(event.target.id)!=='undefined'&&event.target.id=='mps_register'){self.showCreate();}
if(typeof(event.target.id)!=='undefined'&&event.target.id=='mps_login'){self.showLogin();}
event.preventDefault();});}});headerLink.magnificPopup({delegate:'a.social-login',removalDelay:500,callbacks:{beforeOpen:function(){this.st.mainClass=this.st.el.attr('data-effect');}},midClick:true});}},initObserve:function(){var self=this;$(this.options.loginBtn).on('click',this.resetpassword.bind(this));$(this.options.loginBtntoAccessDocument).on('click',this.resetpasswordMpsplususerAuthentication.bind(this));$(this.options.createBtn).on('click',this.showCreate.bind(this));$(this.options.forgotBtn).on('click',this.showForgot.bind(this));$(this.options.DocumentloginFormforgetBtn).on('click',this.showForgot.bind(this));$(this.options.DocumentLoginFormforgetBtn).on('click',this.showForgot.bind(this));$(this.options.createAccBtn).on('click',this.processCreate.bind(this));$(this.options.createBackBtn).on('click',this.showLogin.bind(this));$(this.options.forgotSendBtn).on('click',this.processForgot.bind(this));$(this.options.forgotBackBtn).on('click',this.showLogin.bind(this));$(this.options.forgotBackBtnMps).on('click',this.mpsplusDocumentLogin.bind(this));this.loginForm.find('input').keypress(function(event){var code=event.keyCode||event.which;if(code==13){document.getElementById("bnt-social-login-authentication").click();}});this.DocumentLoginForm.find('input').keypress(function(event){var code=event.keyCode||event.which;if(code==13){document.getElementById('bnt-document-login-authentication').click();}});this.createForm.find('input').keypress(function(event){var code=event.keyCode||event.which;if(code==13){self.processCreate();}});this.forgotForm.find('input').keypress(function(event){var code=event.keyCode||event.which;if(code==13){self.processForgot();}});},showLogin:function(){$(this.options.forgotBackBtn).css('display','block');$(this.options.forgotBackBtnMps).css('display','none');this.loginFormContainer.show();this.forgotFormContainer.hide();this.createFormContainer.hide();this.upgradenotificaionContainer.hide();this.DocumentloginFormContainer.hide();},showCreate:function(){this.loginFormContainer.hide();this.forgotFormContainer.hide();this.upgradenotificaionContainer.hide();this.DocumentloginFormContainer.hide();this.createFormContainer.show();},mpsplusDocumentLogin:function(){$(this.options.forgotBackBtn).css('display','none');$(this.options.forgotBackBtnMps).css('display','block');this.DocumentloginFormContainer.show();this.loginFormContainer.hide();this.forgotFormContainer.hide();this.createFormContainer.hide();this.upgradenotificaionContainer.hide();},showForgot:function(){this.loginFormContainer.hide();this.forgotFormContainer.show();this.createFormContainer.hide();this.upgradenotificaionContainer.hide();this.DocumentloginFormContainer.hide();return false;this.forgotFormemail.val('');this.forgotFormeDefaultmessage.html('Please enter your email address below to receive a password reset link.');this.forgotFormTitle.html('Forgot Password');this.forgotForm.find('.back').show();if(this.forgotFormContent.find('.error').length){this.forgotFormContent.find('.error').remove();}
if(this.forgotFormContent.find('.success').length){this.forgotFormContent.find('.success').remove();}},showResetpasswordformMpsplusUser:function(){this.removeMsg(this.forgotFormContent,'message-error error message');this.removeMsg(this.forgotFormContent,'message-success success message');var usr_email_id_mpsplususer='';this.loginFormContainer.hide();this.DocumentloginFormContainer.hide();this.forgotFormContainer.show();this.createFormContainer.hide();this.upgradenotificaionContainer.hide();usr_email_id_mpsplususer=this.DocumentloginFormEmailID.val();this.forgotFormemail.val(usr_email_id_mpsplususer);this.forgotFormeDefaultmessage.html('Welcome to the new MPS site. Your account has been migrated and to ensure security the password needs to be reset. Submit your email to receive a password reset link.');this.forgotFormTitle.html('Reset password ');this.forgotForm.find('.back').hide();},showResetpasswordform:function(){var usr_email_id='';this.loginFormContainer.hide();this.forgotFormContainer.show();this.createFormContainer.hide();this.upgradenotificaionContainer.hide();this.DocumentloginFormContainer.hide();usr_email_id=this.loginFormEmailID.val();this.forgotFormemail.val(usr_email_id);this.forgotFormeDefaultmessage.html('Welcome to the new MPS site. Your account has been migrated and to ensure security the password needs to be reset. Submit your email to receive a password reset link.');this.forgotFormTitle.html('Reset password ');this.forgotForm.find('.back').hide();},resetpasswordMpsplususerAuthentication:function(){if(!this.DocumentLoginForm.valid()){return;}
var self=this,options=this.options,loginData={},formDataArray=this.DocumentLoginForm.serializeArray();formDataArray.forEach(function(entry){loginData[entry.name]=entry.value;});this.appendLoading(this.DocuementloginFormContent);var reseturl=this.loginFormContent.find('#check_existing_mps_user').val();var userexists_result='';$.ajax({url:reseturl,type:'POST',data:JSON.stringify(loginData)}).done(function(response){if(response.message==1){self.removeLoading(self.DocuementloginFormContent);self.showResetpasswordformMpsplusUser();}else if(response.message==0){self.processLogintoAccessdocumnet();}else{self.removeLoading(self.DocuementloginFormContent);self.addMsg(self.DocuementloginFormContent,response.message,options.errorMsgClass);}}).fail(function(){self.removeLoading(self.DocuementloginFormContent);self.addMsg(self.DocuementloginFormContent,'Could not authenticate. Please try again later',options.errorMsgClass);});return userexists_result;},resetpassword:function(){if(!this.loginForm.valid()){return;}
var self=this,options=this.options,loginData={},formDataArray=this.loginForm.serializeArray();formDataArray.forEach(function(entry){loginData[entry.name]=entry.value;});this.appendLoading(this.loginFormContent);this.removeMsg(this.loginFormContent,options.errorMsgClass);var reseturl=this.loginFormContent.find('#check_existing_mps_user').val();var userexists_result='';$.ajax({url:reseturl,type:'POST',data:JSON.stringify(loginData)}).done(function(response){if(response.message==1){self.removeLoading(self.loginFormContent);self.showResetpasswordform();}else if(response.message==0){self.processLogin();}else{self.addMsg(self.loginFormContent,response.message,options.errorMsgClass);}}).fail(function(){self.removeLoading(self.loginFormContent);self.addMsg(self.loginFormContent,'Could not authenticate. Please try again later',options.errorMsgClass);});return userexists_result;},processLogin:function(){if(!this.loginForm.valid()){return;}
var self=this,options=this.options,loginData={},formDataArray=this.loginForm.serializeArray();formDataArray.forEach(function(entry){loginData[entry.name]=entry.value;});this.appendLoading(this.loginFormContent);this.removeMsg(this.loginFormContent,options.errorMsgClass);var self=this;$.ajax({url:options.formLoginUrl,type:'POST',data:JSON.stringify(loginData)}).done(function(response){if(response.errors){self.removeLoading(self.loginFormContent);if(response.imgSrc){if(self.loginCaptchaImg.length){self.addMsg(self.loginFormContent,response.message,options.errorMsgClass);self.loginCaptchaImg.attr('src',response.imgSrc);}else{window.location.reload();}}else{self.addMsg(self.loginFormContent,response.message,options.errorMsgClass);}}else{customerData.invalidate(['customer']);self.addMsg(self.loginFormContent,response.message,options.successMsgClass);if(response.redirectUrl){location.reload();}else{location.reload();}}}).fail(function(){self.removeLoading(self.loginFormContent);self.addMsg(self.loginFormContent,'Could not authenticate. Please try again later',options.errorMsgClass);});},processLogintoAccessdocumnet:function(){if(!this.DocumentLoginForm.valid()){return;}
var self=this,options=this.options,loginData={},formDataArray=this.DocumentLoginForm.serializeArray();formDataArray.forEach(function(entry){loginData[entry.name]=entry.value;});this.appendLoading(this.loginFormContent);$('#custom_error_popup').html('');$('#custom_success_popup').html('');$.ajax({url:options.formLoginUrl,type:'POST',data:JSON.stringify(loginData)}).done(function(response){if(response.errors){$('.social-login-ajax-loading').remove();if(response.imgSrc){if(self.loginCaptchaImg.length){$('#custom_error_popup').html(response.message);self.loginCaptchaImg.attr('src',response.imgSrc);}else{window.location.reload();}}else{$('#custom_error_popup').html(response.message);}}else{customerData.invalidate(['customer']);$('#custom_success_popup').html(response.message);var current_doc_url=pdfDocumentUrl;var url=String(document.location.href).replace("#/","");if(current_doc_url!=''){if(url.indexOf('?')>-1){url+='&upgrade_notification=1&doc_id='+current_doc_url;}else{url+='?upgrade_notification=1&doc_id='+current_doc_url;}}
window.location.href=url;}}).fail(function(){self.removeLoading(self.loginFormContent);$('#custom_error_popup').html('Could not authenticate. Please try again later');});},processForgot:function(){if(!this.forgotForm.valid()){return;}
var self=this,options=this.options,parameters=this.forgotForm.serialize();this.appendLoading(this.forgotFormContent);this.removeMsg(this.forgotFormContent,options.errorMsgClass);this.removeMsg(this.forgotFormContent,options.successMsgClass);$.ajax({url:options.forgotFormUrl,type:'POST',data:parameters}).done(function(response){self.removeLoading(self.forgotFormContent);if(response.success){self.addMsg(self.forgotFormContent,response.message,options.successMsgClass);}else{self.addMsg(self.forgotFormContent,response.message,options.errorMsgClass);}
if(response.imgSrc&&self.forgotCaptchaImg.length){self.forgotCaptchaImg.attr('src',response.imgSrc);}});},processCreate:function(){if(!this.createForm.valid()){return;}
$('.basic_account_signup').click();return false;var self=this,options=this.options,parameters=this.createForm.serialize();this.appendLoading(this.createFormContent);this.removeMsg(this.createFormContent,options.errorMsgClass);$.ajax({url:options.createFormUrl,type:'POST',data:parameters}).done(function(response){if(response.redirect){window.location.href=response.redirect;}else if(response.success){customerData.invalidate(['customer']);self.addMsg(self.createFormContent,response.message,options.successMsgClass);window.location.reload(true);}else{self.removeLoading(self.createFormContent);if(response.imgSrc){if(self.createCaptchaImg.length){self.addMsg(self.createFormContent,response.message,options.errorMsgClass);self.createCaptchaImg.attr('src',response.imgSrc);}else{window.location.reload();}}else{self.addMsg(self.createFormContent,response.message,options.errorMsgClass);}}});},appendLoading:function(block){block.css('position','relative');block.prepend($("<div></div>",{"class":this.options.loadingClass}))},removeLoading:function(block){block.css('position','');block.find("."+this.options.loadingClass).remove();},addMsg:function(block,message,messageClass){if(typeof(message)==='object'&&message.length>0){message.forEach(function(msg){this._appendMessage(block,msg,messageClass);}.bind(this));}else if(typeof(message)==='string'){this._appendMessage(block,message,messageClass);}},removeMsg:function(block,messageClass){block.find('.'+messageClass.replace(/ /g,'.')).remove();},_appendMessage:function(block,message,messageClass){var currentMessage=null;var messageSection=block.find("."+messageClass.replace(/ /g,'.'));if(!messageSection.length){block.prepend($('<div></div>',{'class':messageClass}));currentMessage=block.children().first();}else{currentMessage=messageSection.first();}
currentMessage.append($('<div>'+message+'</div>'));}});return $.mageplaza.socialpopup;});